#!/usr/bin/ruby
require           'rubygems'
gem               'aws-sdk'
require           'aws-sdk'

EB_CONFIG_APP_SUPPORT = ENV['EB_CONFIG_APP_SUPPORT']
ENVIRONMENT = ENV['RACK_ENV']

whenever_eb = Whenever::Elasticbeanstalk.new(Aws::InstanceProfileCredentials.new)

`export PATH=/usr/local/bin:$PATH` unless `echo $PATH` =~ '/usr/local/bin'

command_prefix = '/usr/local/bin/bundle exec whenever'
command_suffix = " --set 'environment=#{ENVIRONMENT}&path=/var/app/current' --update-crontab"

if whenever_eb.leader?
  `#{[command_suffix, '--roles leader', command_prefix].join(' ')}`
else
  `#{[command_suffix, '--roles non-leader', command_prefix].join(' ')}`
end
